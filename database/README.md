# Database Layer

This directory contains the **data layer services** that provide persistent storage, caching, and database management capabilities. These services depend on the infrastructure layer and must be deployed before applications.

## 🗄️ Purpose

The database layer provides:
- **Persistent Data Storage** - PostgreSQL clusters for application data
- **Database Operators** - Automated database lifecycle management
- **Caching Layer** - Redis for high-performance data access
- **Database Management** - Administrative tools and interfaces
- **Data Security** - Secret management for database credentials

## 📦 Services

### **PostgreSQL Infrastructure**
- **`cnpg-operator/`** - CloudNative PostgreSQL Operator
  - Manages PostgreSQL cluster lifecycle
  - Provides high availability, backup, and recovery
  - Enterprise-grade PostgreSQL management

- **`cloudnative-pg/`** - PostgreSQL cluster and databases
  - 3-node highly available PostgreSQL 16 cluster
  - Pre-configured databases: `appdb`, `n8n`, `temporal`, `temporal_visibility`
  - Automated backups to LocalStack S3
  - Resource limits and monitoring integration

### **Caching Infrastructure**
- **`redis/`** - Redis cluster
  - Master-replica Redis setup with Sentinel
  - High availability with automatic failover
  - Autoscaling replicas (2-3 instances)
  - Persistent storage for data durability

- **`redisinsight/`** - Redis management interface
  - Web-based Redis administration tool
  - Query execution and data visualization
  - Performance monitoring and analytics

### **Database Management**
- **`pgadmin4/`** - PostgreSQL administration tool
  - Web-based PostgreSQL management interface  
  - Query editor and database administration
  - User management and security configuration
  - Integrates with PostgreSQL cluster credentials

## 🔄 Deployment Order

Services in this layer are deployed in dependency order:
1. **CNPG Operator** - PostgreSQL operator foundation
2. **CloudNative PostgreSQL** - Database clusters and schemas
3. **Redis** - Caching infrastructure
4. **RedisInsight** - Redis management tools
5. **pgAdmin4** - PostgreSQL management tools

## 🔗 Dependencies

### **Requires (from infrastructure layer):**
- **External Secrets Operator** - For database credential management
- **LocalStack** - For backup storage (S3) and secrets
- **Traefik** - For web interface access (pgAdmin4, RedisInsight)
- **Monitoring** - For database metrics and alerting

### **Provides to (apps layer):**
- **PostgreSQL databases** - Ready-to-use application databases
- **Redis caching** - High-performance data access
- **Database credentials** - Automatically managed secrets
- **Monitoring endpoints** - Database health and performance metrics

## 🗃️ Database Schema

### **PostgreSQL Databases:**
- **`appdb`** - General application database
- **`n8n`** - N8N workflow automation data
- **`temporal`** - Temporal workflow engine data
- **`temporal_visibility`** - Temporal visibility and monitoring data

### **Credentials Management:**
- Database passwords are auto-generated by CNPG operator
- Credentials are synced to LocalStack Secrets Manager
- External Secrets automatically creates Kubernetes secrets
- Applications consume credentials via secret references

## 📊 High Availability

- **PostgreSQL**: 3-node cluster with automatic failover
- **Redis**: Master-replica with Sentinel for HA
- **Backups**: Automated daily backups to S3-compatible storage
- **Monitoring**: Integrated with Prometheus for alerting

## 📝 Configuration

Environment-specific configurations are applied via patches in:
- `clusters/stages/dev/` - Development environment overrides
- `clusters/stages/prod/` - Production environment overrides

Base configurations are environment-agnostic and located in `database/base/`.